{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/navbar.css' %}">
{% endblock %}
{% block extra_scripts %}
<script src="{% static 'js/navbar.js' %}"></script>
{% endblock %}


{% block content %}
<div class="container py-5">
        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="step" id="cart-progress"></div>
        </div>

        {% if messages %}
        <div class="messages mb-3">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    
    <div class="row">
        <!-- Formulario de Envío -->
        <div class="col-md-7 mb-4">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">Datos de Envío</h3>
                    
                    <form method="POST" action="{% url 'procesar_pago' %}">
                        {% csrf_token %}
                        
                        <!-- Datos personales -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nombre" class="form-label">Nombre</label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="nombre" name="nombre" required
                                       placeholder="Tu nombre">
                            </div>
                            <div class="col-md-6">
                                <label for="apellido" class="form-label">Apellido</label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="apellido" name="apellido" required
                                       placeholder="Tu apellido">
                            </div>
                        </div>

                        <!-- Contacto -->
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control form-control-lg" 
                                       id="email" name="email" required
                                       placeholder="tu@email.com">
                            </div>
                            <div class="col-md-6">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">+56</span>
                                    <input type="tel" class="form-control form-control-lg" 
                                           id="telefono" name="telefono" required
                                           placeholder="9 1234 5678">
                                </div>
                            </div>
                        </div>

                        <!-- Dirección -->
                        <div class="mt-4">
                            <label for="direccion" class="form-label">Dirección de Envío</label>
                            <input type="text" class="form-control form-control-lg" 
                                   id="direccion" name="direccion" required
                                   placeholder="Calle, Número, Depto/Casa">
                        </div>

                        <!-- Dentro del formulario, antes del botón -->
                        <div class="payment-methods-section mt-4 mb-4">
                            <div class="card shadow-sm border-0">
                                <div class="card-body p-3">
                                    <!-- Todo en una sola fila -->
                                    <div class="row align-items-center">
                                        <!-- Título y WebPay -->
                                        <div class="col-md-4">
                                            <div class="d-flex flex-column align-items-center">
                                                <h6 class="mb-2 payment-title">
                                                    <span class="badge bg-light text-dark px-3 py-2">
                                                        <i class="fas fa-credit-card me-1"></i>
                                                        Métodos de pago
                                                    </span>
                                                </h6>
                                                <div class="webpay-logo-wrapper p-2 bg-light rounded-3">
                                                    <img src="{% static 'img/Webpay_CL_FB_80px.png' %}" 
                                                         alt="WebPay Transbank" 
                                                         class="img-fluid webpay-logo"
                                                         style="max-height: 35px;">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tarjetas -->
                                        <div class="col-md-4">
                                            <div class="cards-container text-center">
                                                <div class="d-inline-flex gap-2 p-2 bg-light rounded-3">
                                                    <div class="card-icon"><i class="fab fa-cc-visa fa-2x"></i></div>
                                                    <div class="card-icon"><i class="fab fa-cc-mastercard fa-2x"></i></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Información de seguridad -->
                                        <div class="col-md-4">
                                            <div class="security-info d-flex justify-content-center gap-3">
                                                <div class="security-item text-center">
                                                    <i class="fas fa-shield-alt text-success"></i>
                                                    <small class="text-muted ms-1">Pago 100% seguro</small>
                                                </div>
                                                <div class="security-item text-center">
                                                    <i class="fas fa-lock fa-lg text-success"></i>
                                                    <small class="text-muted ms-1">Certificado SSL</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-lock me-2"></i>
                            Continuar al pago seguro
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Resumen del Pedido -->
        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">Resumen del Pedido</h3>
                    
                    <!-- Productos -->
                    <div class="order-items mb-4">
                        {% if carrito %}
                            {% for key, item in carrito.items %}
                            <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    {% if item.imagen %}
                                    <img src="{{ item.imagen }}" alt="{{ item.nombre }}" 
                                         class="me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-0">{{ item.nombre }}</h6>
                                        <small class="text-muted">
                                            Cantidad: {{ item.cantidad }}
                                        </small>
                                    </div>
                                </div>
                                <span class="fw-bold">${{ item.precio|floatformat:0|intcomma }}</span>
                            </div>
                            {% endfor %}
                            
                            <!-- Totales -->
                            <div class="border-top pt-3 mt-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal</span>
                                    <span>${{ subtotal|floatformat:0|intcomma }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Envío</span>
                                    <span>
                                        {% if shipping == 0 %}
                                            <span class="badge bg-success">Gratis</span>
                                        {% else %}
                                            ${{ shipping|floatformat:0|intcomma }}
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mt-3 pt-3 border-top">
                                    <strong class="h5 mb-0">Total</strong>
                                    <strong class="h5 mb-0">${{ total|floatformat:0|intcomma }}</strong>
                                </div>
                            </div>
                            
                            <!-- Información adicional -->
                            <div class="mt-4">
                                <div class="alert alert-info d-flex align-items-center" role="alert">
                                    <i class="fas fa-truck me-2"></i>
                                    <div>
                                        {% if subtotal >= 20000 %}
                                            ¡Envío gratis en tu pedido!
                                        {% else %}
                                            Envío gratis en compras sobre $20.000
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                <p class="mb-0">No hay productos en el carrito</p>
                                <a href="{% url 'productos' %}" class="btn btn-primary mt-3">
                                    Ir a comprar
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS Adicional -->
<style>
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .card {
        border: none;
        border-radius: 10px;
    }
    
    .btn-primary {
        padding: 12px 20px;
        font-weight: 600;
    }
    
    .order-items .bg-light {
        transition: all 0.3s ease;
    }
    
    .order-items .bg-light:hover {
        background-color: #e9ecef !important;
    }
    
    .fa-cc-visa { color: #1A1F71; }
    .fa-cc-mastercard { color: #EB001B; }
    
    .card-body img {
        transition: transform 0.2s ease;
    }
    
    .card-body img:hover {
        transform: scale(1.05);
    }
</style>
{% endblock %}