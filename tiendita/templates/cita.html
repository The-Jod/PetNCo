{% extends "base.html" %} <!-- extiende el contenido del archivo mencionado (base.html)-->
{% load static %} <!-- Renderiza archivos estáticos-->

{% block title %}Página de Inicio - Vet & Pet Center{% endblock %}
{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/navbar.css' %}">
<link rel="stylesheet" href="{% static 'css/citas.css' %}">
{% endblock %}
{% block extra_scripts %}
<script src="{% static 'js/navbar.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.3/main.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

{% endblock %}
{% block content %}<!-- Deja pasar el contenido de esta vista -->

<h2>Lista de Citas</h2>
<a href="{% url 'cita_add' %}" class="btn btn-primary">Agregar Cita</a>
<form method="get" class="mb-3">
    <div class="row">
        <div class="col">
            <select name="estado" class="form-select">
                <option value="">Filtrar por Estado</option>
                {% for estado in estados %}
                <option value="{{ estado.0 }}" {% if filtros.estado==estado.0 %}selected{% endif %}>{{ estado.1 }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col">
            <input type="date" name="fecha_desde" class="form-control" value="{{ filtros.fecha_desde }}">
        </div>
        <div class="col">
            <input type="date" name="fecha_hasta" class="form-control" value="{{ filtros.fecha_hasta }}">
        </div>
        <div class="col">
            <select name="veterinaria" class="form-select">
                <option value="">Filtrar por Veterinaria</option>
                {% for veterinaria in veterinarias %}
                <option value="{{ veterinaria.id }}" {% if filtros.veterinaria==veterinaria.id %}selected{% endif %}>{{
                    veterinaria.NombreVeterinaria }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col">
            <button type="submit" class="btn btn-secondary">Filtrar</button>
        </div>
    </div>
</form>
<table class="table">
    <thead>
        <tr>
            <th>Servicio</th>
            <th>Veterinaria</th>
            <th>Veterinario</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for cita in citas %}
        <tr>
            <td>{{ cita.servicio }}</td>
            <td>{{ cita.veterinaria.NombreVeterinaria }}</td>
            <td>{{ cita.veterinario }}</td>
            <td>{{ cita.fecha }}</td>
            <td>{{ cita.hora }}</td>
            <td>{{ cita.get_estado_display }}</ </td>
            <td>
                <a href="{% url 'cita_edit' cita.pk %}" class="btn btn-warning">Editar</a>
                <form action="{% url 'cita_delete' cita.pk %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializar FullCalendar
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/api/calendario/',
            eventClick: function (info) {
                cargarCita(info.event.id);
            }
        });
        calendar.render();

        // Cargar veterinarias
        fetch('/api/veterinarios/')
            .then(response => response.json())
            .then(data => {
                const veterinarias = data.veterinarias;
                const selectVeterinaria = document.getElementById('veterinaria');
                const selectVeterinariaModal = document.getElementById('veterinariaModal');

                veterinarias.forEach(vet => {
                    const option = new Option(vet.nombre, vet.id);
                    selectVeterinaria.add(option.cloneNode(true));
                    selectVeterinariaModal.add(option);
                });
            });

        // Event Listeners
        document.getElementById('veterinariaModal').addEventListener('change', cargarVeterinarios);
        document.getElementById('fecha').addEventListener('change', cargarHorariosDisponibles);
        document.getElementById('filterForm').addEventListener('submit', aplicarFiltros);
        document.getElementById('guardarCita').addEventListener('click', guardarCita);

        // Cargar datos iniciales
        cargarCitas();
    });

    function cargarVeterinarios() {
        const veterinariaId = document.getElementById('veterinariaModal').value;
        const selectVeterinario = document.getElementById('veterinario');

        selectVeterinario.innerHTML = '<option value="">Seleccione un veterinario</option>';

        if (veterinariaId) {
            fetch(`/api/veterinarios/?veterinaria_id=${veterinariaId}`)
                .then(response => response.json())
                .then(data => {
                    data.veterinarios.forEach(vet => {
                        const option = new Option(vet.usuario__NombreUsuario, vet.id);
                        selectVeterinario.add(option);
                    });
                });
        }
    }

    function cargarHorariosDisponibles() {
        const fecha = document.getElementById('fecha').value;
        const veterinarioId = document.getElementById('veterinario').value;
        const selectHora = document.getElementById('hora');

        selectHora.innerHTML = '<option value="">Seleccione una hora</option>';

        if (fecha && veterinarioId) {
            fetch(`/api/horarios-disponibles/?fecha=${fecha}&veterinario_id=${veterinarioId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        data.horarios.forEach(hora => {
                            const option = new Option(hora, hora);
                            selectHora.add(option);
                        });
                    }
                });
        }
    }

    function aplicarFiltros(event) {
        event.preventDefault();
        cargarCitas();
    }

    function cargarCitas(page = 1) {
        const formData = new FormData(document.getElementById('filterForm'));
        const queryParams = new URLSearchParams(formData);
        queryParams.append('page', page);

        fetch(`/citas/?${queryParams.toString()}`)
            .then(response => response.json())
            .then(data => {
                actualizarTablaCitas(data.citas);
                actualizarPaginacion(data.pagination);
            });
    }

    function actualizarTablaCitas(citas) {
        const tbody = document.getElementById('citasTableBody');
        tbody.innerHTML = '';

        citas.forEach(cita => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${cita.fecha}</td>
                <td>${cita.hora}</td>
                <td>${cita.servicio}</td>
                <td>${cita.veterinario}</td>
                <td><span class="badge bg-${getEstadoColor(cita.estado)}">${cita.estado}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="cargarCita(${cita.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="cancelarCita(${cita.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function getEstadoColor(estado) {
        const colores = {
            'PENDIENTE': 'warning',
            'CONFIRMADA': 'success',
            'CANCELADA': 'danger'
        };
        return colores[estado] || 'secondary';
    }

    function actualizarPaginacion(pagination) {
        const paginationEl = document.getElementById('pagination');
        paginationEl.innerHTML = '';

        // Agregar botones de paginación...
    }

    function cargarCita(id) {
        fetch(`/api/citas/${id}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('citaId').value = data.id;
                document.getElementById('servicio').value = data.servicio;
                document.getElementById('veterinariaModal').value = data.veterinaria;
                cargarVeterinarios().then(() => {
                    document.getElementById('veterinario').value = data.veterinario;
                });
                document.getElementById('fecha').value = data.fecha;
                document.getElementById('hora').value = data.hora;
                document.getElementById('notas').value = data.notas;

                const modal = new bootstrap.Modal(document.getElementById('citaModal'));
                modal.show();
            });
    }

    function guardarCita() {
        const formData = new FormData(document.getElementById('citaForm'));
        const id = document.getElementById('citaId').value;
        const url = id ? `/api/citas/${id}/` : '/api/citas/';
    }
</script>
{% endblock %}